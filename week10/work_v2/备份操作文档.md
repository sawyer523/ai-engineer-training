# 知识库 FAISS 备份脚本

本脚本在目录 `work/` 下提供知识库 FAISS 数据库与相关索引文件的备份能力，满足命名规范、目录结构保留、完整性校验与日志记录等要求。

## 依赖与环境

- Python 3.8+（使用标准库，无第三方依赖）

## 备份范围

- 源目录默认：`work/faiss_index/`
- 包含：`faiss_index/` 下的所有文件（如 `index.faiss`、`index.pkl` 等），并在压缩包中保留 `faiss_index/` 的目录结构。

## 使用方法

- 默认执行：

```bash
python work/backup.py
```

- 指定源与目标目录：

```bash
python work/backup.py --source d:\AI工程化训练营\workspace\week10\work\faiss_index --dest d:\AI工程化训练营\workspace\week10\work\backup
```

- 模拟磁盘空间不足（用于测试）：

```bash
python work/backup.py --simulate-low-disk
```

## 命名规范

- 首次备份：`kb_YYYYMMDD.zip`
- 同日后续备份：`kb_YYYYMMDD_vN.zip`（N 从 1 递增）

## 完整性校验

- 在压缩前进行：
  - `index.pkl` 使用 `pickle.load` 校验可读性。
  - `.faiss` 二进制文件存在且非空。

## 错误处理

- 磁盘空间不足：优雅失败并记录日志。
- 文件权限异常：记录错误并以非零退出码返回。
- 完整性失败：记录错误并以非零退出码返回。

## 日志记录

- 位置：`work/backup/backup.log`
- 内容：备份时间、文件名、版本号、状态（success/failure）。

## 测试

- 运行测试：

```bash
python -m unittest -v work.tests.test_backup
```

- 覆盖范围：
  - 同日多次备份版本递增。
  - 压缩文件的完整性与可恢复性（含目录结构）。
  - 磁盘空间不足时的优雅处理。
  - 日志记录准确性。

## 恢复说明

- 解压生成的 zip 文件，内部保留 `faiss_index/` 目录结构，直接覆盖或替换目标目录即可完成恢复。
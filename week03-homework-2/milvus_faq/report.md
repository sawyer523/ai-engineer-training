# 作业一：基于 Milvus 的 FAQ 检索系统 - 实验报告

## 系统概述

本系统实现了一个基于 Milvus 向量数据库和 LlamaIndex 的语义 FAQ 检索系统，支持：
- 语义相似度检索（非关键词匹配）
- 文档语义切分与重叠
- 知识库热更新（自动 re-index）
- RESTful API 接口

## 架构设计

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   用户问题      │────▶│   FastAPI       │────▶│  FAQIndexManager│
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  FAQ 答案返回   │◀────│   查询结果处理   │◀────│  LlamaIndex     │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼
                                                 ┌─────────────────┐
                                                 │     Milvus      │
                                                 │  Vector Store   │
                                                 └─────────────────┘
```

## 核心组件说明

### 1. FAQIndexManager (索引管理器)
- 负责初始化和管理向量索引
- 使用 `SemanticSplitterNodeParser` 实现语义切分
- 使用 `MilvusVectorStore` 持久化向量数据

### 2. 嵌入模型
- 使用 `OpenAI text-embedding-3-small` 向量模型
- Embedding 维度：1536
- 支持自定义 API Base（兼容 OpenAI 格式的接口）

### 3. 语义切分策略
- 使用 `SemanticSplitterNodeParser` 而非固定窗口切分
- 自动识别语义边界进行切分
- 可配置切分参数

### 4. 热更新机制
- 使用 `watchdog` 监控文件变化
- 自动触发重新索引
- 支持后台异步更新

## 部署说明

### 1. 启动 Milvus
```bash
cd milvus_faq
docker-compose up -d
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 运行服务
```bash
# 直接运行演示模式
python -m milvus_faq.main

# 或启动 API 服务器
uvicorn milvus_faq.main:app --host 0.0.0.0 --port 8000
```

## API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /health | GET | 健康检查 |
| /status | GET | 获取索引状态 |
| /query | POST | 查询 FAQ |
| /reload | POST | 手动重新加载 |

## 技术亮点

1. **语义检索**：相比关键词匹配，能理解问题语义意图
2. **语义切分**：自动识别语义边界，提高检索质量
3. **热更新**：无需重启服务即可更新知识库
4. **异步设计**：全异步架构，支持高并发
5. **可扩展**：支持水平扩展和分布式部署

## 测试结果

### 实际测试输出

```
问题: 我想退货怎么办
  [1] 相似度: 0.683
      Q: 如何退货？
      A: 您可以在订单页面申请退货，退货原因请选择具体原因，我们会在1-3个工作日内处理。
  [2] 相似度: 0.668
      Q: 怎么申请退款？
      A: 登录账户后，进入订单详情，点击申请退款按钮即可。

问题: 退款要几天
  [1] 相似度: 0.690
      Q: 退款需要多长时间？
      A: 退款通常在1-3个工作日内原路返回，具体到账时间取决于您的银行或支付平台。
  [2] 相似度: 0.568
      Q: 如何退货？
      A: 您可以在订单页面申请退货，退货原因请选择具体原因，我们会在1-3个工作日内处理。

问题: 如何申请退货退款
  [1] 相似度: 0.729
      Q: 怎么申请退款？
      A: 登录账户后，进入订单详情，点击申请退款按钮即可。
  [2] 相似度: 0.671
      Q: 如何退货？
      A: 您可以在订单页面申请退货，退货原因请选择具体原因，我们会在1-3个工作日内处理。

问题: 你们支持什么付款方式
  未找到相关结果
```

### 测试分析

| 测试问题 | 最佳匹配 | 相似度 | 结果 |
|---------|---------|--------|------|
| 我想退货怎么办 | 如何退货？ | 0.683 | ✅ 准确 |
| 退款要几天 | 退款需要多长时间？ | 0.690 | ✅ 准确 |
| 如何申请退货退款 | 怎么申请退款？ | 0.729 | ✅ 准确 |
| 你们支持什么付款方式 | - | - | ⚠️ 未找到（知识库中无相关数据） |

### API 测试示例

```bash
curl -X 'POST' \
  'http://localhost:8000/query' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "question": "我想退货怎么办",
  "top_k": 2,
  "threshold": 0.5
}'
```

响应：
```json
[
  {
    "question": "如何退货？",
    "answer": "您可以在订单页面申请退货，退货原因请选择具体原因，我们会在1-3个工作日内处理。",
    "score": 0.683,
    "category": "售后"
  },
  {
    "question": "怎么申请退款？",
    "answer": "登录账户后，进入订单详情，点击申请退款按钮即可。",
    "score": 0.668,
    "category": "售后"
  }
]
```

## 扩展项完成情况

- ✅ 支持热更新知识库（自动 re-index）
- ✅ 提供 RESTful API 接口（FastAPI 封装）
- ✅ 使用 LlamaIndex 构建索引
- ✅ 部署 Milvus 作为向量库
- ✅ 实现文档切片优化（语义切分）

# 作业二：融合文档检索、图谱推理的多跳问答系统 - 实验报告

## 系统概述

本系统实现了一个融合 RAG（文档检索）和 KG（知识图谱）的多跳问答系统，专门用于查询企业股权关系：
- 使用 Neo4j 构建企业股权图谱
- 使用 LlamaIndex 实现文档检索
- 实现多跳查询逻辑（Cypher + LLM 协同）
- 构建可解释性输出（展示推理路径）

## 系统流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        用户问题                                    │
│              "A 公司的最大股东是谁？"                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 1: 实体识别                                                   │
│ - 从问题中提取公司名称                                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 2: 图谱查询 (Neo4j + Cypher)                                  │
│ - 查找目标公司节点                                                  │
│ - 多跳追踪股权关系                                                  │
│ - 计算实际持股比例                                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 3: 文档检索 (RAG)                                             │
│ - 使用 LlamaIndex 检索相关文档                                      │
│ - 补充图谱外的背景信息                                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 步骤 4: 联合评分与答案生成                                          │
│ - 融合图谱和文档结果                                                │
│ - 使用 LLM 生成自然语言回答                                         │
│ - 输出推理路径                                                      │
└──────────────────────────────────────────────────────────────────┘
```

## 核心组件说明

### 1. Neo4jKnowledgeGraph (图谱管理器)
负责管理企业股权图谱，提供：
- 公司节点管理
- 股权关系管理
- 多跳股权查询
- 控制链追踪

### 2. DocumentRetriever (文档检索器)
基于 LlamaIndex 的文档检索：
- 向量相似度检索
- 语义匹配
- 背景信息补充

### 3. GraphRAGEngine (多跳问答引擎)
融合 RAG 和图谱推理：
- 实体识别
- 多跳推理
- 置信度计算
- 可解释性输出

## 技术难点解决方案

### 1. RAG 与图谱推理融合
**方案**：采用"图谱为主，文档为辅"的策略
- 先使用图谱查询获取结构化股权关系
- 再使用 RAG 检索补充背景信息
- 最后由 LLM 融合生成自然回答

### 2. 联合评分机制
**方案**：多维度置信度计算
```python
confidence = base_confidence + graph_boost + rag_boost
- base_confidence: 0.7 (基础分)
- graph_boost: +0.15~0.20 (图谱结果)
- rag_boost: +0.10 (文档补充)
```

### 3. 防止错误传播
**方案**：多层验证机制
- 图谱查询设置持股比例阈值（>1%）
- 控制链追踪只保留控股路径（>20%）
- 置信度低的回答提示用户核实

## 可解释性输出示例

### 实际测试结果

```
问题: 星辰科技的最大股东是谁？

推理路径:
  步骤 1: 从问题 '星辰科技的最大股东是谁？' 中识别出核心实体 -> '星辰科技'

  步骤 2: 识别到关键词'最大股东'，构造精确 Cypher 查询
     - 图谱查询结果: [{'shareholder': '启明资本', 'percentage': 45.0}]

  步骤 3: 通过 RAG 检索关于 '星辰科技' 的背景文档信息

  步骤 4: 综合图谱结果和文档信息，由 LLM 生成最终回答

回答:
星辰科技的最大股东是启明资本，持股比例为45%。
```

### 多跳查询示例（启明资本的股东）

```
问题: 启明资本的最大股东是谁？

推理路径:
  步骤 1: 从问题 '启明资本的最大股东是谁？' 中识别出核心实体 -> '启明资本'

  步骤 2: 识别到关键词'最大股东'，构造精确 Cypher 查询
     - 图谱查询结果: [{'shareholder': '国家主权基金', 'percentage': 60.0}]

  步骤 3: 通过 RAG 检索关于 '启明资本' 的背景文档信息

  步骤 4: 综合图谱结果和文档信息，由 LLM 生成最终回答

回答:
启明资本的最大股东是国家主权基金，持股比例为60%。
```

### 原始示例（演示数据结构）

```
问题: 阿里巴巴集团的最大股东是谁？（示例数据）

推理路径:
  步骤 1: 识别问题中的公司实体: 阿里巴巴集团

  步骤 2: 在图谱中找到公司: 阿里巴巴集团

  步骤 3: 通过图谱查询发现 4 个股东

回答:
根据股权图谱查询结果，阿里巴巴集团的主要股东如下：
- 蚂蚁集团: 持股 33.00%
- 软银集团: 持股 15.20%
- 雅虎: 持股 10.50%
- 马云慈善基金会: 持股 8.90%

最大股东是蚂蚁集团，持股 33.00%。

置信度: 0.85
```

## 部署说明

### 1. 启动 Neo4j
```bash
cd graph_rag
docker-compose up -d
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 运行服务
```bash
# 直接运行演示模式
python -m graph_rag.main

# 或启动 API 服务器
uvicorn graph_rag.main:app --host 0.0.0.0 --port 8001
```

## API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /health | GET | 健康检查 |
| /stats | GET | 获取图谱统计 |
| /query | POST | 执行 GraphRAG 查询 |
| /shareholders | POST | 直接获取股东信息 |

## Cypher 查询示例

多跳股权查询：
```cypher
MATCH path = (source:Company)-[:HOLDS_SHARE*1..3]->(target:Company {id: $id})
WITH source, target, reduce(p = 1.0, r IN relationships(path) | p * r.percentage) as total_percentage
WHERE total_percentage > 0.01
RETURN source.name, total_percentage
ORDER BY total_percentage DESC
```

## 测试数据

### 实际测试股权结构（shareholders.csv）

```
公司名称: 星辰科技
- 启明资本: 45%
- 李明: 20%
- 红杉基金: 15%
- 王伟: 10%

公司名称: 启明资本
- 国家主权基金: 60%
- 张三: 30%
```

**股权关系图：**
```
国家主权基金(60%) ──▶ 启明资本(45%) ──▶ 星辰科技
                        ▲                   │
                        │                   ├─ 李明(20%)
                     张三(30%)              ├─ 红杉基金(15%)
                                            └─ 王伟(10%)

多跳查询：星辰科技的最终实际控制人 → 国家主权基金
（启明资本 × 45%）×（国家主权基金 × 60%）= 27% 间接持股
```

### 原始示例股权结构（演示数据结构）

```
软银集团(20%) ──▶ 蚂蚁集团(33%) ──▶ 阿里巴巴集团
                      ▲                        │
                      │                        │
              马云慈善基金会(25%)         马云慈善基金会(8.9%)
                                              ▲
                                              │
                                       软银集团(15.2%)
                                              ▲
                                              │
                                           雅虎(10.5%)
```

## 技术亮点

1. **多跳推理**：能够追踪多层嵌套的股权关系
2. **融合架构**：RAG + KG 双重检索增强
3. **可解释性**：完整展示推理路径和置信度
4. **错误防护**：多层验证防止错误传播
5. **灵活扩展**：支持添加新的关系类型和查询模式
